<%- include("templates/header") %>

<div class="px-4 py-6 mx-auto max-w-4xl">
  <!-- Page header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-gray-800">BUYER HOME PAGE</h1>
    <button
      id="signout"
      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"
    >
      Sign out
    </button>
  </div>

  <!-- Location display -->
  <p class="mb-4 text-gray-700">
    Your current location:
    <span id="city" class="font-medium">Detecting…</span>
  </p>

  <!-- Buyer nav bar -->
  <%- include('templates/navbar_buyer') %>

  <!-- Category Filter Dropdown -->
  <div class="relative mb-6">
    <!-- Toggle button -->
    <button
      id="filterBtn"
      class="w-full flex justify-between items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-left focus:outline-none focus:ring-2 focus:ring-indigo-500"
    >
      <span>
        Category:
        <strong>
          <%= selectedCategory
              ? selectedCategory.charAt(0).toUpperCase() + selectedCategory.slice(1)
              : 'All' %>
        </strong>
      </span>
      <!-- Down arrow -->
      <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- Dropdown menu -->
    <div
      id="filterMenu"
      class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"
    >
      <!-- “All” option -->
      <a
        href="?category="
        class="block px-4 py-2 text-sm hover:bg-gray-100
               <%= selectedCategory === '' ? 'bg-indigo-100 text-indigo-700' : '' %>"
      >
        All
      </a>
      <!-- Dynamic category links -->
      <% categories.forEach(cat => { %>
        <a
          href="?category=<%= cat %>"
          class="block px-4 py-2 text-sm hover:bg-gray-100
                 <%= selectedCategory === cat ? 'bg-indigo-100 text-indigo-700' : '' %>"
        >
          <%= cat.charAt(0).toUpperCase() + cat.slice(1) %>
        </a>
      <% }) %>
    </div>
  </div>
  <!-- End filter -->

  <!-- Listings -->
  <section class="mt-8">
    <h2 class="text-2xl font-semibold mb-4 text-gray-800">All Available Postings</h2>

    <% if (postings.length === 0) { %>
      <p class="text-gray-600">There are currently no postings yet.</p>
    <% } else { %>
      <!-- 2 columns on mobile, 3 on sm+ -->
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
        <% postings.forEach(p => { %>
          <a href="/viewpage?postId=<%= p._id %>" class="block group">
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
              <div class="w-full h-48 overflow-hidden">
                <img
                  src="<%= p.thumbSrc %>"
                  alt="Thumbnail of <%= p.produce %>"
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </div>
              <div class="p-4">
                <h5 class="text-lg font-semibold text-gray-800 mb-1 truncate group-hover:text-indigo-600">
                  <%= p.produce %>
                </h5>
                <p class="text-sm text-gray-600 mb-1">
                  Qty: <%= p.quantity %> | Price: $<%= typeof p.price === 'number' ? p.price.toFixed(2) : p.price %>
                </p>
                <p class="text-xs text-gray-500 mb-2">
                  Posted: <%= new Date(p.createdAt).toLocaleDateString() %>
                </p>
                <p class="text-sm text-gray-700 h-10 overflow-hidden text-ellipsis">
                  <%= p.description %>
                </p>
              </div>
            </div>
          </a>
        <% }) %>
      </div>
    <% } %>
  </section>
</div>

<!-- Include footer/nav as before -->
<%- include("templates/navbar_buyer") %>
<%- include("templates/footer") %>

<script src="/scripts/gemini_scripts.js"></script>
<script>
  // Sign-out
  document.getElementById("signout")?.addEventListener("click", () => {
    window.location.href = "/logout";
  });

  // Geolocation → city (unchanged)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async ({ coords }) => {
      const { latitude, longitude } = coords;
      const res = await fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
        `${longitude},${latitude}.json?access_token=<%= mapboxToken %>`
      );
      const json = await res.json();
      const place = json.features.find(f => f.place_type.includes('place'));
      document.getElementById('city').textContent = place?.text || 'Unknown';
    }, () => {
      document.getElementById('city').textContent = 'Permission denied';
    });
  } else {
    document.getElementById('city').textContent = 'Geolocation not supported';
  }

  // Filter dropdown toggle
  const filterBtn = document.getElementById('filterBtn');
  const filterMenu = document.getElementById('filterMenu');
  filterBtn.addEventListener('click', () => filterMenu.classList.toggle('hidden'));
  document.addEventListener('click', e => {
    if (!filterBtn.contains(e.target) && !filterMenu.contains(e.target)) {
      filterMenu.classList.add('hidden');
    }
  });
</script>
