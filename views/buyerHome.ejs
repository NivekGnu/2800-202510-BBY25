<%- include("templates/header") %>

<div class="px-4 py-6">
  <!-- Page header with title and sign out button -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold">BUYER HOME PAGE</h1>
    <button
      id="signout"
      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"
    >
      Sign out
    </button>
  </div>

  <!-- Display detected city or fallback message -->
  <p class="mb-4">
    Your current location:
    <span id="city" class="font-medium">Detecting…</span>.
  </p>

  <!-- Buyer navigation bar (e.g. Map / Cart / Chat / Profile) -->
  <%- include('templates/navbar_buyer') %>

  <!-- Category Filter Dropdown -->
  <div class="relative mb-6">
    <!-- Toggle button shows current category -->
    <button
      id="filterBtn"
      class="w-full flex justify-between items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-left focus:outline-none focus:ring-2 focus:ring-indigo-500"
    >
      <span>
        Category:
        <strong>
          <%= selectedCategory
              ? selectedCategory.charAt(0).toUpperCase() + selectedCategory.slice(1)
              : 'All' %>
        </strong>
      </span>
      <!-- Down arrow icon -->
      <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- Dropdown menu  -->
    <div
      id="filterMenu"
      class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"
    >
      <!-- “All” option -->
      <a
        href="?category="
        class="block px-4 py-2 text-sm hover:bg-gray-100
               <%= selectedCategory === '' ? 'bg-indigo-100 text-indigo-700' : '' %>"
      >
        All
      </a>
      <!-- Dynamically render each category -->
      <% categories.forEach(cat => { %>
        <a
          href="?category=<%= cat %>"
          class="block px-4 py-2 text-sm hover:bg-gray-100
                 <%= selectedCategory === cat ? 'bg-indigo-100 text-indigo-700' : '' %>"
        >
          <%= cat.charAt(0).toUpperCase() + cat.slice(1) %>
        </a>
      <% }) %>
    </div>
  </div>
  <!-- End Category Filter Dropdown -->

  <!-- Listings grid -->
  <section class="mt-8">
    <h2 class="text-2xl font-semibold mb-4">All Available Postings</h2>

    <% if (postings.length === 0) { %>
      <!-- No postings message -->
      <p class="text-gray-600">There are currently no postings yet.</p>
    <% } else { %>
      <!-- Responsive grid: 2 columns on mobile, 3 on md+ -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <% postings.forEach(p => { %>
          <!-- Single posting card -->
          <div class="bg-white shadow-lg rounded-lg overflow-hidden flex flex-col h-full">
            <!-- Thumbnail -->
            <div class="w-full aspect-square bg-gray-100 overflow-hidden">
              <img
                src="<%= p.thumbSrc %>"
                alt="Thumbnail of <%= p.produce %>"
                class="w-full h-full object-cover object-center"
              />
            </div>
            <!-- Details -->
            <div class="flex-1 p-4 flex flex-col">
              <h3 class="text-lg font-medium truncate mb-2"><%= p.produce %></h3>
              <p class="text-sm text-gray-600 mb-1">
                Quantity: <span class="font-medium"><%= p.quantity %></span>
              </p>
              <p class="text-sm text-gray-600 mb-1">
                Price: <span class="font-medium"><%= p.price %></span>
              </p>
              <p class="text-xs text-gray-500 mb-2">
                Posted on <%= p.createdAt.toLocaleDateString() %>
              </p>
              <p class="text-sm text-gray-700 mb-4 flex-1"><%= p.description %></p>
            </div>
            <!-- View full image button -->
            <div class="px-4 pb-4">
              <a
                href="<%= p.imageSrc %>"
                target="_blank"
                class="block w-full text-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition"
              >
                View Full Image
              </a>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </section>
</div>

<!-- AI Helper Button & Modal -->
<button
  id="ai-helper-button"
  class="fixed bottom-20 right-6 z-50 bg-green-700 hover:bg-green-800 text-white p-3 rounded-full"
>
  <img src="/img/glow-icon.svg" alt="AI Helper Icon" class="w-10 h-10"/>
</button>

<div
  id="ai-modal"
  class="relative z-10 opacity-0 pointer-events-none transition-opacity duration-300 ease-out"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
>
  <!-- Modal backdrop -->
  <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
  <!-- Modal panel -->
  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center p-4 text-center">
      <div
        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
      >
        <!-- Modal header -->
        <div class="bg-gray-500 px-4 py-3">
          <h3 id="modal-title" class="text-lg text-center font-semibold text-black">
            What are some produce in season right now?
          </h3>
        </div>
        <!-- Modal body -->
        <div class="bg-white px-4 pt-2 pb-4 sm:p-6 sm:pb-4">
          <div class="mt-2 max-h-60 overflow-y-auto">
            <p id="output" class="text-sm text-gray-700"></p>
          </div>
        </div>
        <!-- Modal footer -->
        <div class="bg-gray-100 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
          <button
            id="close-modal"
            type="button"
            class="inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white hover:bg-green-500 sm:ml-3 sm:w-auto"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="scripts/gemini_scripts.js"></script>
<script>
  // Sign out button handler
  document.getElementById("signout")
    .addEventListener("click", () => window.location.href = "/logout");

  // Geolocation → city name via Mapbox
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async ({ coords }) => {
      const { latitude, longitude } = coords;
      const res = await fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
        `${longitude},${latitude}.json?access_token=<%= mapboxToken %>`
      );
      const json = await res.json();
      const place = json.features.find(f => f.place_type.includes('place'));
      document.getElementById('city').textContent = place?.text || 'Unknown';
    }, () => {
      document.getElementById('city').textContent = 'Permission denied';
    });
  } else {
    document.getElementById('city').textContent = 'Geolocation not supported';
  }

  // Filter dropdown toggle behavior
  const filterBtn = document.getElementById('filterBtn');
  const filterMenu = document.getElementById('filterMenu');
  filterBtn.addEventListener('click', () => {
    filterMenu.classList.toggle('hidden');
  });
  document.addEventListener('click', e => {
    if (!filterBtn.contains(e.target) && !filterMenu.contains(e.target)) {
      filterMenu.classList.add('hidden');
    }
  });
</script>

<%- include("templates/footer") %>
